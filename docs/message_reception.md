# メッセージ受信処理（特にrace condition対策）
NT horikawa
2023.07.24

## 構造
### 単純なケース
* サーバからのメッセージは、各々、所定のboxに格納される。
* メッセージを受け取るスレッドはboxからメッセージを取り出す。
  * boxにメッセージが届いていない場合はメッセージ受信処理を行う。

### メッセージ受信処理
* メッセージ受信処理では、届いたメッセージを所定のboxに格納する。
  * この際、メッセージを格納すべきboxは、メッセージのheader情報により特定できる。

## 複数スレッドによるメッセージ受け取り
### 受信動作の排他制御
複数のスレッドが、boxにッセージが格納されていない状態でメッセージを受け取ろうとした場合の動作は下記。
* 複数スレッドがメッセージ受信処理を行おうとするが、実際にメッセージ受信処理を行うのはその中の１スレッドのみ。
  * 他のスレッドは、メッセージ受信処理を行うスレッドが何らかのメッセージを受信するまでconditionを使ってwaitする。
* メッセージ受信処理を行うスレッドがメッセージを受信すると、condition経由で待っているスレッドにnotifyする。

### 発生しうるrace condition
#### raceとなるケース1
メッセージを受け取るあるスレッド（スレッド1）の動作
* [step 1] boxにメッセージが届いていないことを確認。
* [step 2] 他のスレッドがメッセージ受信処理を行っていないことを確認したので、メッセージ受信処理を行う。
  
メッセージ受信処理を行っているスレッド（スレッド2）の動作
* スレッド1が必要としているメッセージを受信
* condition経由でnotify
* 自分が必要としているメッセージではないので受信処理を継続
* スレッド2が必要としているメッセージを受信
* condition経由でnotify（念のため）
* 自分が必要としているメッセージが到着したので受信処理を終了
  
スレッド1のstep 1と2の間に上記スレッド2の全動作が行われてしまうとraceとなる。
この場合、スレッド1は必要なメッセージが既に到着しているにも関わらず受信処理を行うことになるので、届かないメッセージを待ち続けることになる。

#### raceとなるケース2
メッセージを受け取るあるスレッド（スレッド1）の動作
* [step 1] boxにメッセージが届いていないことを確認。
* [step 2] メッセージ受信処理を行おうとするが、他のスレッドがメッセージ受信処理を行っていることが判明。
* [step 3] conditionを使ってwaitする。
  
メッセージ受信処理を行っているスレッド（スレッド2）の動作
* スレッド1が必要としているメッセージを受信
* condition経由でnotify
* 自分が必要としているメッセージではないので受信処理を継続
* スレッド2が必要としているメッセージを受信
* condition経由でnotify（念のため）
* 自分が必要としているメッセージが到着したので受信処理を終了

スレッド1のstep 2と3の間に上記スレッド2の全動作が行われてしまうとraceとなる。
この場合、スレッド1のstep 3はconditionからのnotifyを受け取ることができないため、waitから抜け出せなくなってしまう。

### race condition対策
#### ケース1
step 2を下記手順で行うことで、「raceとなるケース1」を回避する。
* [step 2-1] 他のスレッドがメッセージ受信処理を行っていないことを確認
* [step 2-2] メッセージ受信処理の排他制御（lock）を獲得
* [step 2-3] step 1で確認して以降、メッセージが届いていないことを確認。届いていればstep 1に戻る。
* [step 2-4] メッセージ受信処理を行う。

#### ケース2
step 3を下記手順で行うことで、「raceとなるケース2」を回避する。
* [step 3-1] conditionを使うためのlockを獲得する
* [step 3-2] step 1で確認して以降、メッセージが届いていないことを確認。届いていればstep 1に戻る。
* [step 3-3] conditionでwaitする。
  
また、スレッド2による「condition経由でnotify」は、conditionを使うためのlockを獲得してから行う。
